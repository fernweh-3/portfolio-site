name: Deploy

on:
  push:
    branches:
      - main
      - feat/git-action
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run Tests
    env:
      TESTING: true
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Setup Python Virtual Environment
        run: |
          python -m venv .venv

      - name: Install dependencies
        run: |
          .venv/bin/pip install -r requirements.txt

      - name: Run tests
        run: |
          ./run_test.sh

      - name: Notify Discord (tests success)
        if: success()
        run: |
          curl -s -X POST "${{ secrets.DISCORD_WEBHOOK }}" -d "content=âœ… Tests Passed"

      - name: Notify Discord (tests failure)
        if: failure()
        run: |
          curl -s -X POST "${{ secrets.DISCORD_WEBHOOK }}" -d "content=âŒ Tests Failed"

  deploy:
    name: "Deploy to VPS"
    runs-on: ubuntu-latest
    needs: test # Ensure tests pass before deploying
    steps:
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh/
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key.pem
          chmod 600 ~/.ssh/deploy_key.pem
          cat >> ~/.ssh/config <<END
          Host my-vps
            HostName $SSH_IP
            User $SSH_USER
            IdentityFile ~/.ssh/deploy_key.pem
            StrictHostKeyChecking no
          END
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_IP: ${{ secrets.SSH_IP }}

      - name: Print Project Directory
        run: |
          ssh my-vps 'cd ${{ secrets.PROJECT_ROOT }} && pwd'

      - name: Deploy Site
        run: |
          ssh my-vps 'cd ${{ secrets.PROJECT_ROOT }} && chmod +x redeploy-site.sh && ~/redeploy-site.sh'

      - name: Print Out Container Status
        run: |
          ssh my-vps 'cd ${{ secrets.PROJECT_ROOT }} && docker compose ps'

      - name: Deployment Notification
        run: |
          curl -s -X POST "${{ secrets.DISCORD_WEBHOOK }}" -d "content=ðŸš€ Deployment Successful"

      - name: Deployment Notification (success)
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
          RUN_ID: ${{ github.run_id }}
          BRANCH: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          SERVER_URL: ${{ github.server_url }}
        run: |
          COMMIT_URL="$SERVER_URL/$REPO/commit/$SHA"
          RUN_URL="$SERVER_URL/$REPO/actions/runs/$RUN_ID"
          SHORT_SHA="${SHA::7}"
          NOW="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"

          payload=$(jq -n \
          --arg commit_url "$COMMIT_URL" \
          --arg run_url "$RUN_URL" \
          --arg repo "$REPO" \
          --arg actor "$ACTOR" \
          --arg short_sha "$SHORT_SHA" \
          --arg branch "$BRANCH" \
          --arg now "$NOW" \
          '{
            content: "ðŸš€ Deployment Successful",
            embeds: [{
              title: "View Commit",
              url: $commit_url,
              description: ("**" + $repo + "** deployed by **" + $actor + "**"),
              color: 5814783,
              fields: [
                { name: "Commit", value: $short_sha, inline: true },
                { name: "Branch", value: $branch, inline: true },
                { name: "Workflow Run", value: $run_url }
              ],
              timestamp: $now
            }]
          }')
          curl -s -H "Content-Type: application/json" -X POST "$DISCORD_WEBHOOK" -d "$payload"

      - name: Deployment Notification (failure)
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
          RUN_ID: ${{ github.run_id }}
          BRANCH: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          SERVER_URL: ${{ github.server_url }}
        run: |
          COMMIT_URL="$SERVER_URL/$REPO/commit/$SHA"
          RUN_URL="$SERVER_URL/$REPO/actions/runs/$RUN_ID"
          SHORT_SHA="${SHA::7}"
          NOW="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          payload=$(jq -n \
            --arg commit_url "$COMMIT_URL" \
            --arg run_url "$RUN_URL" \
            --arg repo "$REPO" \
            --arg actor "$ACTOR" \
            --arg short_sha "$SHORT_SHA" \
            --arg branch "$BRANCH" \
            --arg now "$NOW" \
            '{
              content: "âŒ Deployment Failed",
              embeds: [{
                title: "View Commit",
                url: $commit_url,
                description: ("**" + $repo + "** deployment failed (by **" + $actor + "**)"),
                color: 15548997,
                fields: [
                  { name: "Commit", value: $short_sha, inline: true },
                  { name: "Branch", value: $branch, inline: true },
                  { name: "Workflow Run", value: $run_url }
                ],
                timestamp: $now
              }]
            }')
          curl -fsS -H "Content-Type: application/json" -X POST "$DISCORD_WEBHOOK" -d "$payload"
